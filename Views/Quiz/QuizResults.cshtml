@{
    ViewBag.Title = "Quiz Results";
    var quiz = ViewBag.Quiz as QuizAppDotNetFrameWork.Models.Quiz;
    var isAdmin = Session["Role"]?.ToString() == "Admin";
    // 🆕 ADD THESE - You'll need to pass them from your controller
    var userAnswers = ViewBag.UserAnswers as List<QuizAppDotNetFrameWork.Models.UserResponse>;
    var questions = ViewBag.Questions as List<QuizAppDotNetFrameWork.Models.Question>;
}

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-success text-white text-center">
                    <h4 class="card-title mb-0">
                        <i class="bi bi-trophy me-2"></i>Quiz Completed!
                    </h4>
                </div>
                <div class="card-body text-center">
                    <!-- Score Display -->
                    <div class="score-circle mx-auto mb-4">
                        <div class="circle-progress">
                            <span class="progress-value">@ViewBag.Percentage.ToString("0")%</span>
                        </div>
                    </div>

                    <h3 class="text-success">@ViewBag.Score/@ViewBag.TotalQuestions Correct</h3>
                    <h5 class="text-muted mb-4">@quiz.Title</h5>

                    <!-- Grade Badge -->
                    <div class="mb-4">
                        <span class="badge bg-primary fs-6 p-2">Grade: @ViewBag.Grade</span>
                    </div>

                    <!-- Performance Message -->
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        @if (ViewBag.Percentage >= 80)
                        {
                            <strong>Excellent!</strong> @:You have a great understanding of this topic.
                        }
                        else if (ViewBag.Percentage >= 60)
                        {
                            <strong>Good job!</strong> @:You passed the quiz successfully.
                        }
                        else
                        {
                            <strong>Keep practicing!</strong> @:Review the material and try again.You got it.
                        }
                    </div>

                    <!-- 🆕 ANSWER REVIEW SECTION -->
                    <div class="mt-5 text-start">
                        <h5 class="border-bottom pb-2">
                            <i class="bi bi-list-check me-2"></i>Answer Review
                        </h5>

                        @if (questions != null && userAnswers != null)
                        {
                            for (int i = 0; i < questions.Count; i++)
                            {
                                var question = questions[i];
                                var userAnswer = userAnswers.FirstOrDefault(ua => ua.QuestionId == question.QuestionId);
                                var userSelectedOption = question.Options.FirstOrDefault(o => o.OptionId == userAnswer?.SelectedOptionId);
                                var correctOption = question.Options.FirstOrDefault(o => o.IsCorrect);

                                <div class="card mb-3 @(userAnswer?.IsCorrect == true ? "border-success" : "border-danger")">
                                    <div class="card-header @(userAnswer?.IsCorrect == true ? "bg-success text-white" : "bg-danger text-white")">
                                        <strong>Question @(i + 1):</strong> @question.QuestionText
                                        <span class="badge @(userAnswer?.IsCorrect == true ? "bg-light text-success" : "bg-warning text-dark") float-end">
                                            @(userAnswer?.IsCorrect == true ? "✓ Correct" : "✗ Incorrect")
                                        </span>
                                    </div>
                                    <div class="card-body">
                                        <!-- User's Answer -->
                                        <div class="mb-2">
                                            <strong>Your Answer:</strong>
                                            <span class="@(userAnswer?.IsCorrect == true ? "text-success fw-bold" : "text-danger")">
                                                @(userSelectedOption?.OptionText ?? "Not answered")
                                            </span>
                                        </div>

                                        <!-- Correct Answer (Show only if wrong) -->
                                        @if (userAnswer?.IsCorrect == false)
                                        {
                                            <div class="mb-2">
                                                <strong>Correct Answer:</strong>
                                                <span class="text-success fw-bold">
                                                    @correctOption?.OptionText
                                                </span>
                                            </div>
                                        }

                                        <!-- Options List -->
                                        <div class="small text-muted mt-2">
                                            <strong>All Options:</strong>
                                            <ul class="list-unstyled mt-1">
                                                @foreach (var option in question.Options)
                                                {
                                                    <li class="@(option.IsCorrect ? "text-success fw-bold" : "") @(option.OptionId == userAnswer?.SelectedOptionId && !option.IsCorrect ? "text-danger" : "")">
                                                        @if (option.IsCorrect)
                                                        {
                                                            <i class="bi bi-check-circle-fill me-1"></i>
                                                        }
                                                        else if (option.OptionId == userAnswer?.SelectedOptionId)
                                                        {
                                                            <i class="bi bi-x-circle-fill me-1"></i>
                                                        }
                                                        else
                                                        {
                                                            <i class="bi bi-circle me-1"></i>
                                                        }
                                                        @option.OptionText
                                                    </li>
                                                }
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                Answer review not available for this attempt.
                            </div>
                        }
                    </div>

                    <!-- Action Buttons -->
                    <div class="d-grid gap-2 d-md-flex justify-content-center mt-4">
                        @if (!isAdmin)
                        {
                            <a href="@Url.Action("Questions", new { quizId = quiz.QuizId })" class="btn btn-warning me-md-2">
                                <i class="bi bi-arrow-repeat me-2"></i>Retry Quiz
                            </a>

                            <a href="@Url.Action("AssignedQuizzes", "Quiz")" class="btn btn-primary">
                                <i class="bi bi-list-check me-2"></i>My Assignments
                            </a>
                        }
                        else
                        {
                            <a href="@Url.Action("AdminResults", "Quiz")" class="btn btn-info me-md-2">
                                <i class="bi bi-graph-up me-2"></i>View Analytics
                            </a>
                            <a href="@Url.Action("Index", "Admin")" class="btn btn-secondary">
                                <i class="bi bi-speedometer2 me-2"></i>Admin Dashboard
                            </a>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    body {
        background-color: #1a1a1a;
        color: #ffffff;
    }
    .score-circle {
        width: 150px;
        height: 150px;
        position: relative;
    }

    .circle-progress {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        background: conic-gradient(#198754 @(ViewBag.Percentage*3.6)deg, #e9ecef 0deg);
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
    }

    .circle-progress::before {
        content: '';
        position: absolute;
        width: 130px;
        height: 130px;
        border-radius: 50%;
        background: white;
    }

    .progress-value {
        position: relative;
        font-size: 1.5rem;
        font-weight: bold;
        color: #198754;
    }
</style>