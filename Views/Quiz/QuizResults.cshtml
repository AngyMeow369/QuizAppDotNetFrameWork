@{
    ViewBag.Title = "Quiz Results";
    var quiz = ViewBag.Quiz as QuizAppDotNetFrameWork.Models.Quiz;
    var isAdmin = Session["Role"]?.ToString() == "Admin";
    var userAnswers = ViewBag.UserAnswers as List<QuizAppDotNetFrameWork.Models.UserResponse>;
    var questions = ViewBag.Questions as List<QuizAppDotNetFrameWork.Models.Question>;
}

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <!-- Main Results Card -->
            <div class="card bg-dark border-light shadow-lg mb-4">
                <div class="card-header bg-dark border-light text-center py-4">
                    <div class="score-display mb-3">
                        <div class="circle-progress mx-auto">
                            <span class="progress-value">@ViewBag.Percentage.ToString("0")%</span>
                        </div>
                    </div>
                    <h3 class="text-white mb-2">Quiz Completed!</h3>
                    <h5 class="text-white-70">@quiz.Title</h5>
                </div>
                <div class="card-body">
                    <!-- Score Summary -->
                    <div class="row text-center mb-4">
                        <div class="col-md-4">
                            <div class="border border-light rounded p-3 bg-dark">
                                <h4 class="text-success mb-1">@ViewBag.Score/@ViewBag.TotalQuestions</h4>
                                <small class="text-white-70">Correct Answers</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="border border-light rounded p-3 bg-dark">
                                <h4 class="text-info mb-1">@ViewBag.Grade</h4>
                                <small class="text-white-70">Final Grade</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="border border-light rounded p-3 bg-dark">
                                <h4 class="text-warning mb-1">@ViewBag.Percentage.ToString("0")%</h4>
                                <small class="text-white-70">Overall Score</small>
                            </div>
                        </div>
                    </div>

                    <!-- Performance Message -->
                    <div class="alert bg-dark border-info mb-4">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-info-circle fs-5 text-info me-3"></i>
                            <div>
                                @if (ViewBag.Percentage >= 80)
                                {
                                    <strong class="text-info">Excellent Performance!</strong>
                                    <div class="text-white-70">You have demonstrated outstanding understanding of this material.</div>
                                }
                                else if (ViewBag.Percentage >= 60)
                                {
                                    <strong class="text-info">Good Job!</strong>
                                    <div class="text-white-70">You've successfully passed the quiz with a solid performance.</div>
                                }
                                else
                                {
                                    <strong class="text-info">Keep Practicing!</strong>
                                    <div class="text-white-70">Review the material and try again. You're making progress!</div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Answer Review Section -->
            <div class="card bg-dark border-light shadow-sm">
                <div class="card-header bg-dark border-light">
                    <h5 class="card-title mb-0 text-white">
                        <i class="bi bi-list-check me-2"></i>Detailed Review
                    </h5>
                </div>
                <div class="card-body">
                    @if (questions != null && userAnswers != null)
                    {
                        for (int i = 0; i < questions.Count; i++)
                        {
                            var question = questions[i];
                            var userAnswer = userAnswers.FirstOrDefault(ua => ua.QuestionId == question.QuestionId);
                            var userSelectedOption = question.Options.FirstOrDefault(o => o.OptionId == userAnswer?.SelectedOptionId);
                            var correctOption = question.Options.FirstOrDefault(o => o.IsCorrect);
                            var isCorrect = userAnswer?.IsCorrect == true;

                            <div class="question-review mb-4 p-3 border border-light rounded">
                                <!-- Question Header -->
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <h6 class="text-white mb-0">Question @(i + 1)</h6>
                                    <span class="badge @(isCorrect ? "bg-success" : "bg-danger")">
                                        @(isCorrect ? "✓ Correct" : "✗ Incorrect")
                                    </span>
                                </div>

                                <!-- Question Text -->
                                <p class="text-white-90 mb-3">@question.QuestionText</p>

                                <!-- User's Answer -->
                                <div class="mb-2">
                                    <small class="text-white-70">Your answer:</small>
                                    <div class="p-2 rounded @(isCorrect ? "bg-success bg-opacity-10 border border-success" : "bg-danger bg-opacity-10 border border-danger")">
                                        <span class="@(isCorrect ? "text-success" : "text-danger") fw-bold">
                                            @(userSelectedOption?.OptionText ?? "Not answered")
                                        </span>
                                    </div>
                                </div>

                                <!-- Correct Answer (only show if wrong) -->
                                @if (!isCorrect)
                                {
                                    <div class="mb-3">
                                        <small class="text-white-70">Correct answer:</small>
                                        <div class="p-2 rounded bg-success bg-opacity-10 border border-success">
                                            <span class="text-success fw-bold">@correctOption?.OptionText</span>
                                        </div>
                                    </div>
                                }

                                <!-- All Options -->
                                <div class="options-list">
                                    <small class="text-white-70 d-block mb-2">All options:</small>
                                    @foreach (var option in question.Options)
                                    {
                                        var isUserChoice = option.OptionId == userAnswer?.SelectedOptionId;
                                        var isCorrectOption = option.IsCorrect;

                                        <div class="option-item p-2 mb-1 rounded @(isCorrectOption ? "bg-success bg-opacity-10 border border-success" : isUserChoice && !isCorrectOption ? "bg-danger bg-opacity-10 border border-danger" : "bg-dark border border-secondary")">
                                            <div class="d-flex align-items-center">
                                                @if (isCorrectOption)
                                                {
                                                    <i class="bi bi-check-circle-fill text-success me-2"></i>
                                                }
                                                else if (isUserChoice)
                                                {
                                                    <i class="bi bi-x-circle-fill text-danger me-2"></i>
                                                }
                                                else
                                                {
                                                    <i class="bi bi-circle text-white-70 me-2"></i>
                                                }
                                                <span class="@(isCorrectOption ? "text-success fw-bold" : isUserChoice && !isCorrectOption ? "text-danger" : "text-white-80")">
                                                    @option.OptionText
                                                </span>
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="text-center py-4">
                            <i class="bi bi-exclamation-triangle display-4 text-warning mb-3"></i>
                            <h5 class="text-white">Detailed Review Unavailable</h5>
                            <p class="text-white-70">Answer review is not available for this quiz attempt.</p>
                        </div>
                    }
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="card bg-dark border-light mt-4">
                <div class="card-body text-center">
                    <div class="d-flex gap-2 flex-wrap justify-content-center">
                        @if (!isAdmin)
                        {
                            <a href="@Url.Action("Questions", new { quizId = quiz.QuizId })" class="btn btn-outline-warning">
                                <i class="bi bi-arrow-repeat me-2"></i>Retry Quiz
                            </a>
                            <a href="@Url.Action("AssignedQuizzes", "Quiz")" class="btn btn-outline-primary">
                                <i class="bi bi-list-check me-2"></i>My Assignments
                            </a>
                            <a href="@Url.Action("Index", "Home")" class="btn btn-outline-light">
                                <i class="bi bi-house me-2"></i>Dashboard
                            </a>
                        }
                        else
                        {
                            <a href="@Url.Action("AdminResults", "Quiz")" class="btn btn-outline-info">
                                <i class="bi bi-graph-up me-2"></i>View Analytics
                            </a>
                            <a href="@Url.Action("Index", "Quiz")" class="btn btn-outline-light">
                                <i class="bi bi-speedometer2 me-2"></i>Admin Dashboard
                            </a>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    body {
        background-color: #1a1a1a;
        color: #ffffff;
    }

    /* Custom text color classes */
    .text-white-90 {
        color: rgba(255, 255, 255, 0.95) !important;
    }

    .text-white-80 {
        color: rgba(255, 255, 255, 0.85) !important;
    }

    .text-white-70 {
        color: rgba(255, 255, 255, 0.75) !important;
    }

    .text-white-60 {
        color: rgba(255, 255, 255, 0.65) !important;
    }

    /* Score circle */
    .circle-progress {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        background: conic-gradient(#3b82f6 @(ViewBag.Percentage*3.6)deg, #374151 0deg);
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
    }

    .circle-progress::before {
        content: '';
        position: absolute;
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background: #1a1a1a;
    }

    .progress-value {
        position: relative;
        font-size: 1.5rem;
        font-weight: bold;
        color: #3b82f6;
        z-index: 1;
    }

    /* Card improvements */
    .card {
        border: 1px solid #6b7280;
    }

    .border-light {
        border-color: #6b7280 !important;
    }

    /* Badge styles */
    .badge {
        font-size: 0.75em;
        font-weight: 600;
        padding: 0.5em 0.75em;
    }

    /* Button hover effects */
    .btn-outline-primary:hover {
        background-color: #0d6efd;
        border-color: #0d6efd;
        color: white !important;
    }

    .btn-outline-warning:hover {
        background-color: #ffc107;
        border-color: #ffc107;
        color: black !important;
    }

    .btn-outline-info:hover {
        background-color: #0dcaf0;
        border-color: #0dcaf0;
        color: white !important;
    }

    /* Question review animations */
    .question-review {
        transition: all 0.3s ease;
    }

    .question-review:hover {
        border-color: #9ca3af !important;
        transform: translateY(-2px);
    }

    /* Responsive design */
    @@media (max-width: 768px) {
        .circle-progress {
            width: 100px;
            height: 100px;
        }

        .circle-progress::before {
            width: 80px;
            height: 80px;
        }

        .progress-value {
            font-size: 1.25rem;
        }

        .btn {
            font-size: 0.875rem;
            padding: 0.5rem 1rem;
        }
    }
</style>